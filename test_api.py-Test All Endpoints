import requests
import json
from datetime import datetime

# Base URL (ganti dengan URL server kamu)
BASE_URL = "http://localhost:5000"  # Untuk test local
# BASE_URL = "https://your-app-name.onrender.com"  # Untuk production

def test_health():
    """Test health check endpoint"""
    print("ğŸ” Testing health check...")
    try:
        response = requests.get(f"{BASE_URL}/health")
        print(f"âœ… Health Status: {response.status_code}")
        print(f"ğŸ“„ Response: {response.json()}")
    except Exception as e:
        print(f"âŒ Health check failed: {e}")
    print("-" * 50)

def test_single_signal(symbol):
    """Test single signal endpoint"""
    print(f"ğŸ” Testing signal for {symbol}...")
    try:
        response = requests.get(f"{BASE_URL}/signal/{symbol}")
        print(f"âœ… Signal Status: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            print(f"ğŸ“Š Symbol: {data.get('symbol')}")
            print(f"ğŸ’° Current Price: ${data.get('current_price')}")
            print(f"ğŸ“ˆ RSI: {data.get('rsi')}")
            print(f"ğŸ¯ Action: {data.get('action', 'N/A')}")
            
            if data.get('action') in ['BUY', 'SELL']:
                print(f"ğŸ”¹ Entry: ${data.get('entry_price')}")
                print(f"ğŸ¯ TP: ${data.get('tp_price')} ({data.get('pips_tp')} pips)")
                print(f"ğŸ›¡ï¸ SL: ${data.get('sl_price')} ({data.get('pips_sl')} pips)")
                print(f"ğŸ“Š Order Type: {data.get('order_type')}")
                print(f"âš¡ RR: {data.get('risk_reward')}")
        else:
            print(f"âŒ Error: {response.json()}")
            
    except Exception as e:
        print(f"âŒ Signal test failed: {e}")
    print("-" * 50)

def test_all_signals():
    """Test all signals endpoint"""
    print("ğŸ” Testing all signals...")
    try:
        response = requests.get(f"{BASE_URL}/signals/all")
        print(f"âœ… All Signals Status: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            print(f"ğŸ“Š Total Pairs: {data.get('total_pairs')}")
            print(f"â° Timestamp: {data.get('timestamp')}")
            
            for symbol, signal in data.get('signals', {}).items():
                print(f"\nğŸ”¸ {symbol}:")
                print(f"   ğŸ’° Price: ${signal.get('current_price')}")
                print(f"   ğŸ“ˆ RSI: {signal.get('rsi')}")
                print(f"   ğŸ¯ Action: {signal.get('action', 'N/A')}")
                
                if signal.get('action') in ['BUY', 'SELL']:
                    print(f"   ğŸ”¹ Entry: ${signal.get('entry_price')}")
                    print(f"   ğŸ¯ TP: ${signal.get('tp_price')}")
                    print(f"   ğŸ›¡ï¸ SL: ${signal.get('sl_price')}")
        else:
            print(f"âŒ Error: {response.json()}")
            
    except Exception as e:
        print(f"âŒ All signals test failed: {e}")
    print("-" * 50)

def test_multiple_signals():
    """Test multiple signals endpoint"""
    print("ğŸ” Testing multiple signals...")
    try:
        payload = {
            "symbols": ["BTCUSD", "EURUSD", "XAUUSD"]
        }
        
        response = requests.post(
            f"{BASE_URL}/signals/multiple",
            json=payload,
            headers={'Content-Type': 'application/json'}
        )
        
        print(f"âœ… Multiple Signals Status: {response.status_code}")
        
        if response.status_code == 200:
            data = response.json()
            
            for symbol, signal in data.items():
                print(f"\nğŸ”¸ {symbol}:")
                print(f"   ğŸ’° Price: ${signal.get('current_price')}")
                print(f"   ğŸ“ˆ RSI: {signal.get('rsi')}")
                print(f"   ğŸ¯ Action: {signal.get('action', 'N/A')}")
        else:
            print(f"âŒ Error: {response.json()}")
            
    except Exception as e:
        print(f"âŒ Multiple signals test failed: {e}")
    print("-" * 50)

def format_signal_output(signal_data):
    """Format output seperti yang akan dikirim ke Telegram"""
    if signal_data.get('action') in ['BUY', 'SELL']:
        emoji = "ğŸŸ¢" if signal_data['action'] == 'BUY' else "ğŸ”´"
        
        output = f"""
ğŸš¨ Sinyal {signal_data['action']} {signal_data['symbol']} Detected (M5)

ğŸ“Š RSI: {signal_data.get('rsi', 'N/A'):.1f}
ğŸ“Š MACD: {signal_data.get('macd', {}).get('macd', 'N/A'):.4f}
ğŸ“Š Support: ${signal_data.get('support', 'N/A'):.2f}
ğŸ“Š Resistance: ${signal_data.get('resistance', 'N/A'):.2f}

ğŸ“Œ Pending Order:
{emoji} {signal_data.get('order_type', 'N/A')} @ ${signal_data.get('entry_price', 'N/A'):.2f}

ğŸ¯ TP: ${signal_data.get('tp_price', 'N/A'):.2f} ({signal_data.get('pips_tp', 'N/A')} pips)
ğŸ›¡ï¸ SL: ${signal_data.get('sl_price', 'N/A'):.2f} ({signal_data.get('pips_sl', 'N/A')} pips)

ğŸ” RR: {signal_data.get('risk_reward', 'N/A')}
â° Timeframe: M5
ğŸ• Time: {datetime.now().strftime('%H:%M:%S')}
        """
        
        return output.strip()
    
    return f"ğŸ“Š {signal_data.get('symbol', 'N/A')}: {signal_data.get('action', 'HOLD')} - {signal_data.get('reason', 'No signal')}"

if __name__ == "__main__":
    print("ğŸš€ TESTING SINYAL BOT TRADING API")
    print("=" * 50)
    
    # Test 1: Health Check
    test_health()
    
    # Test 2: Single Signals
    pairs = ["BTCUSD", "EURUSD", "XAUUSD", "ETHUSD", "USDJPY"]
    for pair in pairs:
        test_single_signal(pair)
    
    # Test 3: All Signals
    test_all_signals()
    
    # Test 4: Multiple Signals
    test_multiple_signals()
    
    print("ğŸ‰ ALL TESTS COMPLETED!")
    print("=" * 50)
    
    # Demo format output
    print("\nğŸ“± DEMO OUTPUT FORMAT UNTUK TELEGRAM:")
    print("=" * 50)
    
    # Contoh signal BUY
    demo_signal = {
        'symbol': 'BTCUSD',
        'action': 'BUY',
        'current_price': 45230.50,
        'rsi': 28.5,
        'macd': {'macd': 0.0124},
        'support': 45100.00,
        'resistance': 45500.00,
        'entry_price': 45180.00,
        'tp_price': 45280.00,
        'sl_price': 45130.00,
        'order_type': 'BUY_LIMIT',
        'pips_tp': 100,
        'pips_sl': 50,
        'risk_reward': '1:2'
    }
    
    print(format_signal_output(demo_signal))
